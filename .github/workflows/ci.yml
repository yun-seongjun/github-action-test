name: Selective Build

on:
  pull_request:
    branches: [main, dev, staging]

env:
  NEXT_TELEMETRY_DISABLED: "1"

jobs:
  detect-affected:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      build_matrix: ${{ steps.set-build-matrix.outputs.build_matrix }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Detect changed apps and create build matrix
        id: set-build-matrix
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          pull_request_number="${{ github.event.pull_request.number }}"
          repository_full_name="${{ github.repository }}"

          build_matrix="$(
            gh api "repos/$repository_full_name/pulls/$pull_request_number/files" \
              --paginate \
              --jq '
                [.[].filename
                  | select(startswith("apps/"))
                  | split("/")[1]
                ]
                | unique
                | { app: . }
              '
          )"

          # GITHUB_OUTPUT에 안전하게 1줄 JSON으로 기록
          build_matrix="$(echo "$build_matrix" | jq -c '.')"

          echo "build_matrix=$build_matrix" >> "$GITHUB_OUTPUT"
          echo "Build matrix: $build_matrix"

  build:
    needs: detect-affected
    runs-on: ubuntu-latest
    # app 배열이 비어있으면 스킵
    if: ${{ toJson(fromJson(needs.detect-affected.outputs.build_matrix).app) != '[]' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-affected.outputs.build_matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: yarn install

      - name: Build app
        run: yarn nx build ${{ matrix.app }}

name: Selective Build

on:
  pull_request:
    branches: [main, dev, staging]

env:
  NEXT_TELEMETRY_DISABLED: "1"

jobs:
  detect-affected:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build matrix from changed files
        id: set-matrix
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          pr="${{ github.event.pull_request.number }}"
          repo="${{ github.repository }}"

          files="$(gh api "repos/$repo/pulls/$pr/files" --paginate --jq '.[].filename')"

          apps=()
          while IFS= read -r f; do
            case "$f" in
              apps/neubie-go/*)          apps+=("neubie-go") ;;
              apps/neubie-order/*)       apps+=("neubie-order") ;;
              apps/neubie-order-admin/*) apps+=("neubie-order-admin") ;;
            esac
          done <<< "$files"

          # dedupe
          uniq_apps="$(printf '%s\n' "${apps[@]}" | awk 'NF && !seen[$0]++')"

          if [ -z "$uniq_apps" ]; then
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # {"include":[{"app":"neubie-go"},{"app":"neubie-order"}]}
          json='{"include":['
          first=1
          while IFS= read -r a; do
            [ -z "$a" ] && continue
            if [ $first -eq 0 ]; then json+=','; fi
            first=0
            json+='{"app":"'"$a"'"}'
          done <<< "$uniq_apps"
          json+=']}'

          echo "matrix=$json" >> "$GITHUB_OUTPUT"
          echo "Affected apps:"
          echo "$uniq_apps"

  build:
    needs: detect-affected
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.detect-affected.outputs.matrix).include[0] != null }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-affected.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: yarn install

      - name: Build
        run: yarn nx build ${{ matrix.app }}

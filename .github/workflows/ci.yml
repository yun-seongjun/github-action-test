name: Selective Build

on:
  pull_request:
    branches:
      - main
      - dev
      - staging

env:
  NEXT_TELEMETRY_DISABLED: "1"

jobs:
  detect-affected:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.find.outputs.matrix }}
      found: ${{ steps.find.outputs.found }}

    steps:
      - name: Find changed apps
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          pr='${{ github.event.pull_request.number }}'
          repo='${{ github.repository }}'

          # gh api "repos/$repo/pulls/$pr/files" pr에 변경된 파일 목록 가져오기
          # --paginate gh api 응답양이 많아도 전체 가져오기
          # --jq jq필터 적용하기
          # .[].filename ".[]" 배열의 각요소를 각각 꺼낸다 + ".filename" 필드만
          # select(startswith("apps/")) "apps/"로 시작하는 경로만
          # split("/")[1] "apps/{app}/" 에서 실제 앱 이름 app만
          # unique 중복제거
          # | jq -c . "-c" 한줄로 + "." 그대로 출력
          apps=$(gh api "repos/$repo/pulls/$pr/files/files" \
          --paginate --jq '[.[].filename | select(startswith("apps/")) | split("/")[1]] | unique')

          echo "matrix={\"app\":$apps}" >> "$GITHUB_OUTPUT"

          if [ "$apps" = "[]" ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
          else
            echo "found=true" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: detect-affected
    runs-on: ubuntu-latest
    if: needs.detect.outputs.found == 'true'
    # 해당 job을 어떻게 실행할 것인지 정의
    strategy:
      # 메트릭스중 하나가 실패하더라도 디른건 계속 진행
      fail-fast: false
      # 각 메트릭스 항목만큼 실행
      matrix: ${{ fromJson(needs.detect-affected.outputs.build_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build app
        run: yarn nx build ${{ matrix.app }}

name: Selective Build

on:
  pull_request:
    branches: [main, dev, staging]

env:
  NEXT_TELEMETRY_DISABLED: "1"

jobs:
  detect-affected:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      build_matrix: ${{ steps.detect.outputs.build_matrix }}
      has_apps: ${{ steps.detect.outputs.has_apps }}

    steps:
      - name: Detect changed apps and create build matrix
        id: detect
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          pr="${{ github.event.pull_request.number }}"
          repo="${{ github.repository }}"

          apps_json="$(
            gh api "repos/$repo/pulls/$pr/files" --paginate --jq '
              [.[].filename
                | select(startswith("apps/"))
                | split("/")[1]
              ] | unique
            ' | jq -c .
          )"

          echo "build_matrix=$(jq -cn --argjson apps "$apps_json" '{app:$apps}')" >> "$GITHUB_OUTPUT"
          echo "has_apps=$(jq -r 'length>0' <<<"$apps_json")" >> "$GITHUB_OUTPUT"

  build:
    needs: detect-affected
    runs-on: ubuntu-latest
    if: ${{ needs.detect-affected.outputs.has_apps == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-affected.outputs.build_matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: yarn install

      - name: Build app
        run: yarn nx build ${{ matrix.app }}

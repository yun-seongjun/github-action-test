name: Deploy

on:
  workflow_dispatch:
    inputs:
      app:
        description: "Select app to be deployed"
        required: true
        default: "NEUBIE_GO"
        type: choice
        options:
          - NEUBIE_GO
          - NEUBIE_ORDER
          - NEUBIE_ORDER_ADMIN

jobs:
  deploy:
    if: github.ref_name == 'main' || github.ref_name == 'staging'
    runs-on: ubuntu-latest
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ github.event.inputs.app == 'NEUBIE_GO' && secrets.VERCEL_PROJECT_ID_GO || github.event.inputs.app == 'NEUBIE_ORDER' && secrets.VERCEL_PROJECT_ID_ORDER || secrets.VERCEL_PROJECT_ID_ORDER_ADMIN }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

#      - name: Set App Name for slack notification
#        run: |
#          if [[ "${{ github.event.inputs.app }}" == "NEUBIE_GO" ]]; then
#            echo "APP_NAME=Îâ¥ÎπÑÍ≥†" >> $GITHUB_ENV
#          elif [[ "${{ github.event.inputs.app }}" == "NEUBIE_ORDER" ]]; then
#            echo "APP_NAME=Îâ¥ÎπÑÏò§Îçî" >> $GITHUB_ENV
#          elif [[ "${{ github.event.inputs.app }}" == "NEUBIE_ORDER_ADMIN" ]]; then
#            echo "APP_NAME=Îâ¥ÎπÑÏò§Îçî Ïñ¥ÎìúÎØº" >> $GITHUB_ENV
#          fi
#
#      - name: Install Vercel CLI
#        run: npm install --global vercel@latest
#
#      - name: Pull Vercel Environment Information
#        run: |
#          if [ "${{ github.ref_name }}" == "main" ]; then
#            vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
#          else
#            vercel pull --yes --environment=preview --git-branch=staging --token=${{ secrets.VERCEL_TOKEN }}
#          fi
#
#
#      - name: Build Project Artifacts
#        run: |
#          if [ "${{ github.ref_name }}" == "main" ]; then
#            vercel build --prod
#          else
#            vercel build
#          fi
#
#      - name: Deploy Project Artifacts to Vercel
#        run: |
#          if [ "${{ github.ref_name }}" == "main" ]; then
#            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
#          else
#            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
#          fi
#
#      - name: Slack Notification
#        if: always()
#        uses: rtCamp/action-slack-notify@v2
#        env:
#          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
#          SLACK_COLOR: ${{ job.status == 'success' && 'good' || job.status == 'failure' && 'danger' || 'warning' }}
#          SLACK_CUSTOM_PAYLOAD: |
#            {
#              "blocks": [
#                {
#                  "type": "section",
#                  "text": {
#                    "type": "mrkdwn",
#                    "text": "*üöÄ ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞∞Ìè¨ ÏôÑÎ£å ÏïåÎ¶º*"
#                  }
#                },
#                {
#                  "type": "section",
#                  "text": {
#                    "type": "mrkdwn",
#                    "text": "Ïï±: *${{ env.APP_NAME }}*\nÎ∞∞Ìè¨ ÌôòÍ≤Ω: *${{ github.ref_name }}*\nÎ∞∞Ìè¨ Í≤∞Í≥º: *${{ job.status == 'success' && 'ÏÑ±Í≥µ' || 'Ïã§Ìå®' }}*"
#                  }
#                }
#              ]
#            }
#
#      - name: Trigger QA Test Workflow
#        if: success() && github.ref_name == 'staging'
#        uses: ./.github/actions/trigger-qa-test
#        with:
#          jenkins_url: ${{ secrets.JENKINS_URL }}
#          jenkins_user: ${{ secrets.JENKINS_USER }}
#          jenkins_token: ${{ secrets.JENKINS_TOKEN }}


      - name: Update staging RC version
        if: success() && github.ref_name == 'staging'
        run: |
          git fetch --tags

          LAST_RC_NUM=$(git tag --list 'staging-rc-*' | sed 's/staging-rc-//' | sort -n | tail -n1)

          if [ -z "$LAST_RC_NUM" ]; then
            NEXT_RC_NUM=1
          else
            NEXT_RC_NUM=$((LAST_RC_NUM+1))
          fi

          NEW_TAG="staging-rc-${NEXT_RC_NUM}"
          echo "Create new staging RC tag: ${NEW_TAG}"

          git tag "${NEW_TAG}"
          git push origin "${NEW_TAG}"

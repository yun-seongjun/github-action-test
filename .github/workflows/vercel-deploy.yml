name: Deploy

on:
  workflow_dispatch:
    inputs:
      app:
        description: "ë°°í¬í•  ì•±ì„ ì„ íƒí•˜ì„¸ìš”"
        required: true
        default: "NEUBIE_GO"
        type: choice
        options:
          - NEUBIE_GO
          - NEUBIE_ORDER
          - NEUBIE_ORDER_ADMIN

jobs:
  deploy:
    if: github.ref_name == 'main' || github.ref_name == 'staging'
    runs-on: ubuntu-latest
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ github.event.inputs.app == 'NEUBIE_GO' && secrets.VERCEL_PROJECT_ID_GO || github.event.inputs.app == 'NEUBIE_ORDER' && secrets.VERCEL_PROJECT_ID_ORDER || secrets.VERCEL_PROJECT_ID_ORDER_ADMIN }}

    steps:
      - uses: actions/checkout@v4

      - name: Resolve app name and path from workflow input
        run: |
          if [[ "${{ github.event.inputs.app }}" == "NEUBIE_GO" ]]; then
            echo "APP_NAME=ë‰´ë¹„ê³ " >> $GITHUB_ENV
            echo "APP_PATH=apps/neubie-go" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.app }}" == "NEUBIE_ORDER" ]]; then
            echo "APP_NAME=ë‰´ë¹„ì˜¤ë”" >> $GITHUB_ENV
            echo "APP_PATH=apps/neubie-order" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.app }}" == "NEUBIE_ORDER_ADMIN" ]]; then
            echo "APP_NAME=ë‰´ë¹„ì˜¤ë” ì–´ë“œë¯¼" >> $GITHUB_ENV
            echo "APP_PATH=apps/neubie-order-admin" >> $GITHUB_ENV
          fi

#      - name: Install Vercel CLI
#        run: npm install --global vercel@latest
#
#      - name: Pull Vercel Environment Information
#        run: |
#          if [ "${{ github.ref_name }}" == "main" ]; then
#            vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
#          else
#            vercel pull --yes --environment=preview --git-branch=staging --token=${{ secrets.VERCEL_TOKEN }}
#          fi
#
#
#      - name: Build Project Artifacts
#        run: |
#          if [ "${{ github.ref_name }}" == "main" ]; then
#            vercel build --prod
#          else
#            vercel build
#          fi
#
#      - name: Deploy Project Artifacts to Vercel
#        run: |
#          if [ "${{ github.ref_name }}" == "main" ]; then
#            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
#          else
#            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
#          fi
#
#      - name: Slack Notification
#        if: always()
#        uses: rtCamp/action-slack-notify@v2
#        env:
#          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
#          SLACK_COLOR: ${{ job.status == 'success' && 'good' || job.status == 'failure' && 'danger' || 'warning' }}
#          SLACK_CUSTOM_PAYLOAD: |
#            {
#              "blocks": [
#                {
#                  "type": "section",
#                  "text": {
#                    "type": "mrkdwn",
#                    "text": "*ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ ì•Œë¦¼*"
#                  }
#                },
#                {
#                  "type": "section",
#                  "text": {
#                    "type": "mrkdwn",
#                    "text": "ì•±: *${{ env.APP_NAME }}*\në°°í¬ í™˜ê²½: *${{ github.ref_name }}*\në°°í¬ ê²°ê³¼: *${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}*"
#                  }
#                }
#              ]
#            }
#
#      - name: Trigger QA Test Workflow
#        if: success() && github.ref_name == 'staging'
#        uses: ./.github/actions/trigger-qa-test
#        with:
#          jenkins_url: ${{ secrets.JENKINS_URL }}
#          jenkins_user: ${{ secrets.JENKINS_USER }}
#          jenkins_token: ${{ secrets.JENKINS_TOKEN }}

      - name: Bump staging RC version from previous staging and recreate branch
        # ì§€ê¸ˆê¹Œì§€ ìŠ¤íƒ­ì´ ì„±ê³µì´ê³ , stagingì¼ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        if: success() && github.ref_name == 'staging'
        run: |
          set -euo pipefail

          APP_PATH="${{ env.APP_PATH }}"
          PACKAGE_JSON="${APP_PATH}/package.json"

          # origin/staging ê¸°ì¤€ìœ¼ë¡œ ë¡œì»¬ ì„ì‹œ ë¸Œëœì¹˜("staging_version_base") ìƒì„± í›„ í˜„ì¬ ë²„ì „ ì½ê¸°
          git fetch origin staging
          git checkout -B staging_version_base origin/staging || {
            # orgin/stagingì„ ë¶ˆëŸ¬ì˜¤ì§€ëª»í•˜ë©´ ì¢…ë£Œ(rcë²„ì „ì„ ì°¾ì„ìˆ˜ ì—†ê¸°ë•Œë¬¸ì—)
            echo "âŒ origin/staging not found. Cannot read RC version."
            exit 1
          }
          CURRENT_VERSION=$(node -p "require('./${PACKAGE_JSON}').version")

          # base(-rc.N) í˜•íƒœë¡œ íŒŒì‹± í›„ rcë²„ì „ ì¦ê°€
          BASE_VERSION="$CURRENT_VERSION"
          RC_NUMBER=0

          # "-rc." ê°€ ë¶™ì–´ ìˆìœ¼ë©´ rc ë²ˆí˜¸ì™€ base ì˜ë¼ë‚´ê¸°
          if [[ "$CURRENT_VERSION" == *-rc.* ]]; then
            # ${ë³€ìˆ˜%íŒ¨í„´} ì€ ë’¤ì—ì„œë¶€í„° ë§¤ì¹­ë˜ëŠ”ê²ƒ ì œê±°. %ëŠ” ì§§ê²Œ ë§¤ì¹­ %%ì€ ê¸¸ê²Œ ë§¤ì¹­
            BASE_VERSION="${CURRENT_VERSION%-rc.*}"
            # ${ë³€ìˆ˜#íŒ¨í„´} ì€ ì•ì—ì„œë¶€í„° íŒ¨í„´ì— ë§¤ì¹­ë˜ëŠ” ë¶€ë¶„ ì œê±°. #ì€ ì§§ê²Œ ë§¤ì¹­, ##ì€ ê¸¸ê²Œ ë§¤ì¹­
            RC_NUMBER="${CURRENT_VERSION##*-rc.}"
          fi

          NEXT_RC_NUMBER=$((RC_NUMBER+1))
          NEW_VERSION="${BASE_VERSION}-rc.${NEXT_RC_NUMBER}"

          # staging ê¸°ì¤€ìœ¼ë¡œ staging ë¸Œëœì¹˜ ì¬ìƒì„± í›„ NEW_VERSION ë°˜ì˜
          git checkout -B staging origin/staging

          node -e "
            const fs = require('fs');
            const path = '${PACKAGE_JSON}';
            const package = JSON.parse(fs.readFileSync(path, 'utf8'));
            package.version = '${NEW_VERSION}';
            fs.writeFileSync(path, JSON.stringify(package, null, 2) + '\n');
            "

          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

          git add "$PACKAGE_JSON"
          git commit -m "ğŸš€ [${APP_PATH#apps/}] ${CURRENT_VERSION} â†’ ${NEW_VERSION}" || echo "No changes to commit"

          # ì›ê²© staging ì‚­ì œ í›„, ìƒˆ staging í‘¸ì‹œ
          git push origin --delete staging || true
          git push -u origin staging

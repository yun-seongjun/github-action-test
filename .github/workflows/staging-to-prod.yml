name: Staging -> Main, Dev

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

env:
  APPS: "neubie-go neubie-order neubie-order-admin"

jobs:
  staging-to-main-and-dev:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.17.1

      - name: Prepare staging (RC -> stable) and recreate remote staging
        id: prep
        shell: bash
        run: |
          set -euo pipefail

          CHANGED_APPS=""
          VERSIONS_LIST=""
          TITLE_SHORT=""
          FIRST_APP=""
          FIRST_VERSION=""
          COUNT=0

          # ëª¨ë“  ëŒ€ìƒ ì•±ì— ëŒ€í•´ RC â†’ stable ë³€í™˜ ìˆ˜í–‰
          for APP in ${{ env.APPS }}; do
            PACKAGE="apps/$APP/package.json"
            [ -f "$PACKAGE" ] || continue

            CURRENT_VERSION="$(node -p "require('./${PACKAGE}').version")"
            [ -n "$CURRENT_VERSION" ] || continue

            # x.y.z-rc.n -> x.y.z ë¡œ ë³€í™˜
            NEW="${CURRENT_VERSION%-rc.*}"

            if [ -n "$NEW" ] && [ "$NEW" != "$CURRENT_VERSION" ]; then
              # package.json ì—ì„œ ë²„ì „ ë¬¸ìžì—´ ì—…ë°ì´íŠ¸
              node -e "
                const fs=require('fs'); const path='${PACKAGE}';
                const package=JSON.parse(fs.readFileSync(path,'utf8'));
                package.version='${NEW}';
                fs.writeFileSync(path, JSON.stringify(package, null, 2)+'\n');
              "
              echo "write: $APP ${CURRENT_VERSION} -> ${NEW}"

              CHANGED_APPS="$CHANGED_APPS $APP"

              # PR ì œëª©ì„ ìœ„í•´ ì²«ë²ˆì¨° app
              if [ -z "$FIRST_APP" ]; then
                FIRST_APP="$APP"
                FIRST_VERSION="$NEW"
              fi

              if [ -z "$VERSIONS_LIST" ]; then
                VERSIONS_LIST="\`${APP}@${NEW}\`"
              else
                VERSIONS_LIST="${VERSIONS_LIST}, \`${APP}@${NEW}\`"
              fi

              COUNT=$((COUNT+1))
            else
              echo "keep:  $APP ${CURRENT_VERSION}"
            fi
          done

          # package.jsonì— ë³€ë™ì´ ìžˆì„ê²½ìš°ì—ë§Œ stagingì— ì»¤ë°‹ + ì›ê²© staging ìž¬ìƒì„±
          if [ -n "$(git status --porcelain apps/*/package.json 2>/dev/null)" ]; then
            git config user.name "GitHub Actions"
            git config user.email "github-actions@github.com"

            git add apps/*/package.json
            git commit -m "release: RC to stable"

            git push origin :staging || true
            git push -u origin staging
          fi

          # ì•± ì´ë¦„ ëª©ë¡ ê³µë°± ì •ë¦¬ (trim)
          CHANGED_APPS="$(echo "$CHANGED_APPS" | xargs || true)"

          # ë‹¤ìŒ step ì—ì„œ ì“¸ output
          echo "head=staging" >> "$GITHUB_OUTPUT"
          echo "changed_apps=$CHANGED_APPS" >> "$GITHUB_OUTPUT"

          if [ "$COUNT" -gt 0 ]; then
            if [ "$COUNT" -eq 1 ]; then
              TITLE_SHORT="\`${FIRST_APP}@${FIRST_VERSION}\`"
            else
              REMAIN=$((COUNT - 1))
              TITLE_SHORT="\`${FIRST_APP}@${FIRST_VERSION}\` ì™¸ ${REMAIN}ê°œ"
            fi
            echo "versions_list=$VERSIONS_LIST" >> "$GITHUB_OUTPUT"
            echo "title_short=$TITLE_SHORT" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR to main & dev
        if: steps.prep.outputs.changed_apps != ''
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          HEAD_REF: ${{ steps.prep.outputs.head }}
          TITLE_SHORT: ${{ steps.prep.outputs.title_short }}
          VERSIONS_LIST: ${{ steps.prep.outputs.versions_list }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          create_pr() {
            local BASE_BRANCH="$1"
            local TITLE_PREFIX="$2"

            git fetch origin "$BASE_BRANCH" "$HEAD_REF"

            local TITLE BODY
            printf -v TITLE '%s %s' "$TITLE_PREFIX" "$TITLE_SHORT"
            printf -v BODY  '%s %s' "$TITLE_PREFIX" "$VERSIONS_LIST"

            gh pr create --repo "$REPO" --base "$BASE_BRANCH" --head "$HEAD_REF" --title "$TITLE" --body  "$BODY"
          }

          create_pr "main" "ðŸš€ Release:"
          create_pr "dev"  "ðŸ”€ Staging -> Dev:"

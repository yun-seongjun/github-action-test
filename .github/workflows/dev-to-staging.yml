name: Dev -> Staging

on:
  workflow_dispatch:
    inputs:
      new_level:
        description: "버전"
        type: choice
        required: true
        default: minor
        options:
          - patch
          - minor
          - major
      apps:
        description: "Target app"
        type: choice
        required: true
        default: auto
        options:
          - auto
          - neubie-go
          - neubie-order
          - neubie-order-admin

permissions:
  contents: write

env:
  APPS: "neubie-go neubie-order neubie-order-admin"

jobs:
  create-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: Prepare staging branch
        shell: bash
        run: |
          set -euo pipefail

          # origin/dev 최신 가져오기
          git fetch origin dev

          # 로컬 staging 브랜치를 origin/dev 기준으로 맞추기
          git checkout -B staging origin/dev

          # 원격 staging 브랜치 삭제
          git push origin :staging 2>/dev/null || true

      - name: Resolve target apps
        id: diff
        shell: bash
        env:
          TARGET_APP: ${{ inputs.apps }}
        run: |
          set -euo pipefail

          CATALOG="${{ env.APPS }}"

          # main 최신 가져오기 (dev와 변경점 체크위해)
          git fetch origin main >/dev/null 2>&1 || true

          TARGETS=""

          if [[ "$TARGET_APP" == "auto" ]]; then
            TARGETAPPS=""
            CHANGED_FILES=$(git diff --name-only origin/main..HEAD 2>/dev/null || true)

            for FILE in $CHANGED_FILES; do
              if [[ "$FILE" == apps/*/* ]]; then
                # "apps/" 제거
                APP="${FILE#apps/}"
                # 첫 "/" 이후 제거
                APP="${APP%%/*}"
                TARGETAPPS="$TARGETAPPS $APP"
              fi
            done

            # "$TARGETAPPS" 한줄씩 문자열 쪼개기 (trim) > 중복 제거 > 다시 한줄로
            TARGETS="$(echo "$TARGETAPPS" | xargs -n1 | sort -u | xargs || true)"
          else
            TARGETS="$TARGET_APP"
          fi

          echo "apps=$TARGETS"
          echo "apps=$TARGETS" >> "$GITHUB_OUTPUT"

      - name: Compute next RC and new version
        if: ${{ steps.diff.outputs.apps != '' }}
        shell: bash
        env:
          NEW_LEVEL: ${{ inputs.new_level }}
        run: |
          set -euo pipefail

          APPS="${{ steps.diff.outputs.apps }}"

          # $APPS 비어 있으면 종료
          if [ -z "$APPS" ]; then
            echo "empty apps" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 버전 변경 함수 (하단 반복문에서 사용)
          new_version () {
            local VERSION="$1" LEVEL="$2" MAJOR MINOR PATCH
            # "."으로 버전 분리
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            MAJOR=${MAJOR:-0}; MINOR=${MINOR:-0}; PATCH=${PATCH:-0}
            case "$LEVEL" in
              major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR+1)); PATCH=0 ;;
              patch|*) PATCH=$((PATCH+1)) ;;
            esac
            echo "${MAJOR}.${MINOR}.${PATCH}"
          }

          for APP in $APPS; do
            PACKAGE="apps/$APP/package.json"
            [ -f "$PACKAGE" ] || continue

            # 현재 버전 base version 가져오기
            BASE=$(node -p "require('./$PACKAGE').version")
            NEW_BASE=$(new_version "$BASE" "$NEW_LEVEL")

            # dev to staging은 버전당 한 번만이라고 가정 → 항상 rc.1
            NEW="${NEW_BASE}-rc.1"

            # package.json version 갱신
            node -e "
              const fs = require('fs');
              const path = '$PACKAGE';
              const package = JSON.parse(fs.readFileSync(path, 'utf8'));
              package.version = '$NEW';
              fs.writeFileSync(path, JSON.stringify(package, null, 2) + '\n');
            "

            git add "$PACKAGE"
            git commit -m "🚀 [$APP] ${BASE} → ${NEW}"
          done

      - name: Push staging branch
        run: |
          git push -u origin HEAD:staging

name: Dev -> Staging

on:
  workflow_dispatch:
    inputs:
      bump_level:
        description: "Version bump"
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major
      apps:
        description: "Target app"
        type: choice
        required: true
        default: auto
        options:
          - auto
          - neubie-go
          - neubie-order
          - neubie-order-admin

permissions:
  contents: write

env:
  APPS: "neubie-go neubie-order neubie-order-admin"

jobs:
  create-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          fetch-tags: true

      - name: Configure Git
        run: |
          git config user.name  "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: Prepare staging branch
        shell: bash
        run: |
          set -euo pipefail

          # origin/dev ìµœì‹  ê°€ì ¸ì˜¤ê¸°
          git fetch origin dev --tags

          # ë¡œì»¬ staging ë¸Œëžœì¹˜ë¥¼ origin/dev ê¸°ì¤€ìœ¼ë¡œ ê°•ì œë¡œ ë§žì¶”ê¸°
          git checkout -B staging origin/dev

          # ì›ê²© staging ë¸Œëžœì¹˜ ì‚­ì œ
          git push origin :staging 2>/dev/null || true

      - name: Resolve target apps
        id: diff
        shell: bash
        env:
          INPUT_APPS: ${{ inputs.apps }}
        run: |
          set -euo pipefail

          CATALOG="${{ env.APPS }}"

          # main ìµœì‹  ê°€ì ¸ì˜¤ê¸° (devì™€ ë³€ê²½ì  ì²´í¬ìœ„í•´)
          git fetch origin main --tags >/dev/null 2>&1 || true

          TARGETAPPS="$INPUT_APPS"

          if [ "$INPUT_APPS" = "auto" ]; then
          # ê²½ë¡œê°€ "apps/" ë¡œ ì‹œìž‘í•˜ë©´ì„œ "/" ê¸°ì¤€ 2ë²ˆì§¸ ê°€ì ¸ì˜¤ê¸°
          TARGETAPPS=$(git diff --name-only origin/main..HEAD 2>/dev/null \
          | awk -F/ '/^apps\//{print $2}' || true)
          fi

          TARGETS=""

          for app in $CATALOG; do
          # TARGETAPPSì— app í¬í•¨ì—¬ë¶€ í™•ì¸
          if printf '%s\n' $TARGETAPPS | grep -qx -- "$app"; then
          # TARGETSê°€ ë¹ˆê°’ì´ë©´ "app", ë¹„ì–´ìžˆì§€ ì•Šìœ¼ë©´ "ê¸°ì¡´ê°’ + ê³µë°± + app"
          TARGETS="${TARGETS:+$TARGETS }$app"
          fi
          done

          echo "apps=$TARGETS"
          echo "apps=$TARGETS" >> "$GITHUB_OUTPUT"

      - name: Compute next RC and bump
        if: ${{ steps.diff.outputs.apps != '' }}
        id: bump
        shell: bash
        env:
          BUMP_LEVEL: ${{ inputs.bump_level }}
        run: |
          set -euo pipefail

          APPS="${{ steps.diff.outputs.apps }}"

          # ë¹„ì–´ ìžˆìœ¼ë©´ ì¢…ë£Œ
          if [ -z "$APPS" ]; then
            echo "nothing=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ì„¸ë¯¸ë²„ ë²„ì „ ì˜¬ë¦¬ëŠ” ê°„ë‹¨ í•¨ìˆ˜
          bump_semi_version () {
            local VER="$1" LVL="$2" MAJOR MINOR PATCH
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VER"
            MAJOR=${MAJOR:-0}; MINOR=${MINOR:-0}; PATCH=${PATCH:-0}
            case "$LVL" in
              major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR+1)); PATCH=0 ;;
              patch|*) PATCH=$((PATCH+1)) ;;
            esac
            echo "${MAJOR}.${MINOR}.${PATCH}"
          }

          TAGS=()

          for APP in $APPS; do
            PKG="apps/$APP/package.json"
            [ -f "$PKG" ] || continue

            # í˜„ìž¬ ë²„ì „ì—ì„œ "-rc.N" ë–¼ê³  baseë§Œ ê°€ì ¸ì˜¤ê¸°
            BASE=$(node -p "require('./$PKG').version.split('-rc.')[0]")
            NEWBASE=$(bump_semi_version "$BASE" "$BUMP_LEVEL")

            # ê¸°ì¡´ rc íƒœê·¸ ê°œìˆ˜ + 1 ë¡œ ë‹¤ìŒ rc ë²ˆí˜¸ ê³„ì‚° (sort/sed ì—†ì´)
            COUNT=$(git tag --list "$APP@${NEWBASE}-rc.*" | wc -l)
            NEXT=$((COUNT + 1))
            NEW="${NEWBASE}-rc.${NEXT}"

            # package.json version ê°±ì‹ 
            node -e "
              const fs = require('fs');
              const p = '$PKG';
              const pkg = JSON.parse(fs.readFileSync(p, 'utf8'));
              pkg.version = '$NEW';
              fs.writeFileSync(p, JSON.stringify(pkg, null, 2) + '\n');
            "

            git add "$PKG"
            git commit -m "ðŸš€ [$APP] ${BASE} â†’ ${NEW}"

            TAGS+=("$APP@$NEW")
          done

          # ë°”ê¿€ ê²Œ ì—†ì—ˆìœ¼ë©´ nothing=true
          if [ ${#TAGS[@]} -eq 0 ]; then
            echo "nothing=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # íƒœê·¸ í•œ ë²ˆì— ìƒì„±
          git tag "${TAGS[@]}"

          echo "nothing=false" >> "$GITHUB_OUTPUT"

      - name: Push staging branch
        run: |
          git push -u origin HEAD:staging

      - name: Push tags
        if: steps.bump.outputs.nothing == 'false'
        run: |
          git push origin --tags

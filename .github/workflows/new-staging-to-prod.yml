name: Staging -> Main, Dev

on:
  workflow_dispatch: {}

permissions:
  pull-requests: write
  contents: write

jobs:
  # staging 브랜치를 main에 머지하는 PR 생성
  create-PR-staging-to-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Read version from package.json
        run: |
          if [ -f package.json ]; then
            echo "SPRINT=$(node -p "require('./package.json').version")" >> "$GITHUB_ENV"
          else
            echo "SPRINT=unknown" >> "$GITHUB_ENV"
          fi

      - name: Check Differences Between Staging and Main
        run: |
          git fetch origin main staging
          if git diff --quiet origin/main origin/staging; then
            echo "No changes detected between staging and main. Skipping PR creation."
            echo "should_skip_main=true" >> $GITHUB_ENV
          else
            echo "Changes detected. Proceeding with PR creation."
            echo "should_skip_main=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.should_skip_main == 'false'
        run: |
          gh pr create \
            --title "🚀 Release ${SPRINT}" \
            --body  "Release ${SPRINT}" \
            --assignee "${{ github.actor }}" \
            --base main --head staging
        env:
          GH_TOKEN: ${{ github.token }}

  # staging 브랜치를 dev에 머지하는 PR 생성
  create-PR-staging-to-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Read version from package.json
        run: |
          if [ -f package.json ]; then
            echo "SPRINT=$(node -p "require('./package.json').version")" >> "$GITHUB_ENV"
          else
            echo "SPRINT=unknown" >> "$GITHUB_ENV"
          fi

      - name: Check Differences Between Staging and Dev
        run: |
          git fetch origin dev staging
          if git diff --quiet origin/dev origin/staging; then
            echo "No changes detected between staging and dev. Skipping PR creation."
            echo "should_skip=true" >> $GITHUB_ENV
          else
            echo "Changes detected. Proceeding with PR creation."
            echo "should_skip=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.should_skip == 'false'
        run: |
          gh pr create \
            --title "🔀 Staging -> Dev (${SPRINT})" \
            --body  "Release ${SPRINT}" \
            --assignee "${{ github.actor }}" \
            --base dev --head staging
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
